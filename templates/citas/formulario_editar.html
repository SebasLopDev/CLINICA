<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clínica Médica</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
    <!-- jQuery (requerido por Bootstrap 4) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <!-- Popper.js (requerido por Bootstrap 4 para componentes como tooltips) -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <!-- Bootstrap 4 JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


    <!-- Enlace al archivo CSS (estático) -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">    
    
</head>
<body>
    
    <main class="container-pagina">
        <div class="contenedor-nav">

            <nav class="nav">
                <a href="{{ url_for('pagina_paciente') }}">Mis datos</a>
                <a href="{{ url_for('consultar_especialidades') }}">Consultar Especialidades</a>
                <a href="{{ url_for('nueva_cita') }}">Reservar Cita</a>
                <a href="{{ url_for('logout') }}">Cerrar sesión</a>            
                
            </nav>
        </div>

        {% with mensajes = get_flashed_messages(with_categories=true) %}
            {% if mensajes %}
                {% for categoria, mensaje in mensajes %}
                <div class="alert alert-{{ categoria }} alert-dismissible fade show mt-3 mx-3" role="alert">
                    {{ mensaje }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

         

         <h2>Editar Cita</h2>

        <div class="container_nueva_listado">


            <form method="post">
            <div class="form-group">
                <label>Fecha:</label>
                <input type="date" name="fecha" class="form-control" value="{{ cita.fecha }}" required>
            </div>
            <div class="form-group">
                <label>Hora:</label>
                <input type="time" name="hora" class="form-control" value="{{ cita.hora }}" required>
            </div>
            <div class="form-group">
                <label>Motivo:</label>
                <input type="text" name="motivo" class="form-control" value="{{ cita.motivo }}" required>
            </div>

            <!-- Especialidad -->
            <div class="form-group">
                <label>Especialidad:</label>
                <select name="id_especialidad" id="select-especialidad" class="form-control" required>
                    <option value="">Seleccione una especialidad</option>
                    {% for esp in especialidades %}
                        <option value="{{ esp.id_especialidad }}" {% if esp.id_especialidad == cita.id_especialidad %}selected{% endif %}>
                            {{ esp.nombre_espclidad }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Médico -->
            <div class="form-group">
                <label>Médico:</label>
                <select name="id_medico" id="select-medico" class="form-control" required>
                    <option value="">Seleccione una especialidad primero</option>
                </select>
            </div>
            <!--
            <div class="form-group">
                <label>Médico:</label>
                <select name="id_medico" class="form-control">
                {% for medico in medicos %}
                <option value="{{ medico.id_medico }}" {% if cita.id_medico == medico.id_medico %}selected{% endif %}>
                    {{ medico.nombre }} {{ medico.apellido }}
                </option>
                {% endfor %}
                </select>
            </div>-->
            <div class="form-group">
                <label>Sala (opcional):</label>
                <select name="id_sala" class="form-control">
                <option value="">-- Sin asignar --</option>
                {% for sala in salas %}
                <option value="{{ sala.id_sala }}" {% if cita.id_sala == sala.id_sala %}selected{% endif %}>
                    {{ sala.nombre }} ({{ sala.tipo }})
                </option>
                {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-success">Guardar cambios</button>
            <a href="{{ url_for('nueva_cita') }}" class="btn btn-secondary">Cancelar</a>
            </form>
        </div>        

    

    <!-- Bloque de contenido que se reemplazará en cada página específica -->
        
    </main>

    <footer class="footer">
        <div class="contenedor-footer">
            <div class="footer-ubicacion">
                <h4>Ubicación</h4>                
                <p>Avenida del Aroma 123,</p>
                <p>Barrio Aromático</p>
                <p>CP 45678</p>
            </div>
            <div class="footer-box reservacion">
                <h4>Reservación</h4>
                <p>Tel. 3850-9102</p>
                <p>Llamar</p>
            </div>
            <div class="footer-box horario">
                <h4>Horario</h4>
                <p>Lun-Jue: 11:00 - 22:00</p>
                <p>Vie-Sab: 09:00 - 24:00</p>
                <p>Domingo: Cerrado</p>
            </div>
        </div>
        <p class="copyright">Todos los derechos reservados. Clínica Medical</p>
    </footer>
</body>

</html>

<script>
    // Función para cargar médicos de una especialidad
    function cargarMedicos(idEspecialidad, idMedicoActual = null) {
        const medicoSelect = document.getElementById("select-medico");
        medicoSelect.innerHTML = "<option>Cargando médicos...</option>";

        fetch(`/api/medicos/${idEspecialidad}`)
            .then(r => r.json())
            .then(data => {
                medicoSelect.innerHTML = '<option value="">Seleccione un médico</option>';
                if (data.medicos.length === 0) {
                    medicoSelect.innerHTML += '<option>No hay médicos disponibles</option>';
                } else {
                    data.medicos.forEach(m => {
                        const opt = document.createElement("option");
                        opt.value = m.id_medico;
                        opt.textContent = `${m.nombre} ${m.apellido}`;
                        if (idMedicoActual && m.id_medico == idMedicoActual) {
                            opt.selected = true;
                        }
                        medicoSelect.appendChild(opt);
                    });
                }
            });
    }

    // Evento: cuando se cambie la especialidad
    document.getElementById("select-especialidad").addEventListener("change", function () {
        const idEspecialidad = this.value;
        cargarMedicos(idEspecialidad);
    });

    // Precargar al cargar la página si ya hay una especialidad
    window.addEventListener("load", function () {
        const selectEspecialidad = document.getElementById("select-especialidad");
        const idEspecialidad = selectEspecialidad.value;
        const idMedicoActual = "{{ cita.id_medico }}";
        if (idEspecialidad) {
            cargarMedicos(idEspecialidad, idMedicoActual);
        }
    });
</script>








